version: '3.8'

services:
  news_reporter:
    image: openclaw-feishu:v1
    container_name: news_reporter
    
    environment:
      # ==========================================
      # 代理配置 - 通过 host.docker.internal 访问宿主机的 VPN
      # 根据你的 VPN 软件修改端口 (常见: 7890, 1080, 8080)
      # ==========================================
      - HTTP_PROXY=http://host.docker.internal:7890
      - HTTPS_PROXY=http://host.docker.internal:7890
      - ALL_PROXY=socks5://host.docker.internal:7890
      
      # ==========================================
      # 其他配置
      # ==========================================
      - TZ=Asia/Shanghai
      - PYTHONUNBUFFERED=1
      - PYTHONIOENCODING=utf-8
      
    # 直接从 .env 文件加载所有配置
    env_file:
      - .env
      
    volumes:
      # 应用代码目录 - 持久化 Git 仓库
      - news_reporter_data:/app/news_reporter
      
      # 输出目录 - 持久化生成的新闻汇总
      - news_reporter_output:/app/news_reporter/output
      
      # 缓存目录 - 持久化 RSS 和 AI 缓存
      - news_reporter_cache:/app/news_reporter/cache
      
      # 保存 openclaw 工作空间
      - news_reporter_openclaw:/root/.openclaw/workspace
      
      # SSH 密钥 - 从宿主机挂载（路径从环境变量 SSH_KEY_PATH 读取）
      # 注意：需要挂载私钥文件（不是 .pub 文件）
      - ${SSH_KEY_PATH}:/root/.ssh/id_ed25519:ro
      
    # 工作目录
    working_dir: /app
    
    # 保持容器运行，方便手动执行
    stdin_open: true
    tty: true
    
    # 启动脚本 - 自动拉取代码并安装依赖
    command: ["bash", "/app/entrypoint.sh"]
    
    # 网络配置 - 使用桥接网络，通过 host.docker.internal 访问宿主机
    extra_hosts:
      - "host.docker.internal:host-gateway"

# 命名卷 - 数据持久化
volumes:
  news_reporter_data:
    name: news_reporter_data
  news_reporter_output:
    name: news_reporter_output
  news_reporter_cache:
    name: news_reporter_cache
  news_reporter_openclaw:
    name: news_reporter_openclaw
